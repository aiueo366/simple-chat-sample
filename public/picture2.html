<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>センサ受信＋画像切り替えアプリ</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
  </head>

  <body>
    <h1>スマホからのセンサ情報を受信（＋画像を切り替える）</h1>
    <div>
      <div>あなたのID: <span id="myid"></span></div>
      <button id="connect">ルームに入る</button>
      <p>スマホを傾けると、一定の角度で画像が切り替わります。</p>
      <div>受信データはコンソールで確認できます。</div>
    </div>

    <script>
      // --- Socket.IO 接続 ---
      const socket = io.connect();

      // --- HTML要素 ---
      const btn = document.querySelector("#connect");

      // --- クライアントID管理 ---
      let myid = sessionStorage.getItem("clientId");
      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem("clientId", myid);
      }
      document.querySelector("#myid").innerText = myid;
      console.log("あなたのID:", myid);

      // --- Socketルーム参加 ---
      btn.addEventListener("click", function () {
        socket.emit("join", "game");
        btn.remove();
      });

      // --- グローバル変数 ---
      // img3, img4 を追加
      let img1, img2, img3, img4, currentImg = null;
      let g = 0, b = 0;

      // --- 画像読み込み ---
      function preload() {
        img1 = loadImage("apple.png");
        img2 = loadImage("orange.png");
        img3 = loadImage("meron.png");
        img4 = loadImage("grape.png");
      }

      // --- p5.js setup ---
      function setup() {
        createCanvas(800, 800, WEBGL);
        camera(0, 800, 100, 0, 0, 0, 0, 1, 0);
        noStroke();
      }

      // --- センサデータ受信 ---
      socket.on("sensor", function (data) {
        g = parseFloat(data.g); // 左右
        b = parseFloat(data.b); // 前後
        console.log("受信データ:", data);

        const threshold = 10; // 傾き

        
        if (Math.abs(g) > threshold || Math.abs(b) > threshold) {
          
         
          if (Math.abs(g) > Math.abs(b)) {
           
            if (g > 0) {
              currentImg = img1; // 右
            } else {
              currentImg = img3; // 左
            }
          } else {
            
            if (b > 0) {
              currentImg = img2; //  前
            } else {
              currentImg = img4; // 後ろ
            }
          }
        } else {
          
          currentImg = null;
        }
      });

      // --- 描画 ---
      function draw() {
        background(0);
        orbitControl();
        ambientLight(50, 50, 50);
        directionalLight(100, 20, 20, -1, -1, -1);
        pointLight(20, 20, 100, 0, 0, 800);

        push();
        rotateX((-PI * b) / 180);
        rotateY((PI * g) / 180);
        translate(0, 0, -50);

        
        if (currentImg) {
         
          texture(currentImg);
        } else {
          
          fill(80);
        }
        
        
        box(800, 800, 30);

        pop();
      }
    </script>
  </body>
</html>